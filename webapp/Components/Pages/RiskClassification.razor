@page "/risk"
@inject HttpClient Http
@using System.Text.Json

<PageTitle>Risk Classification</PageTitle>

<div class="page-header">
    <h1>üéØ Risk Classification</h1>
    <p>Categorize shipments into Low/Moderate/High risk using ML classification</p>
</div>

<div class="how-it-works">
    <h3>üìñ Module Explanation</h3>
    <p>This module performs <strong>Multi-Class Risk Classification</strong> to categorize shipments into:</p>
    <ul>
        <li>üü¢ <strong>Low Risk</strong>: Smooth operations expected</li>
        <li>üü° <strong>Moderate Risk</strong>: Potential minor disruptions</li>
        <li>üî¥ <strong>High Risk</strong>: High probability of severe delay or issues</li>
    </ul>
    <p><strong>AI Model</strong>: XGBoost classifier trained on historical disruption data.</p>
</div>

<div class="kpi-grid">
    <div class="kpi-card">
        <div class="kpi-value">@totalShipments.ToString("N0")</div>
        <div class="kpi-label">Total Shipments</div>
    </div>
    <div class="kpi-card danger">
        <div class="kpi-value">@highRiskCount.ToString("N0")</div>
        <div class="kpi-label">High Risk</div>
    </div>
    <div class="kpi-card warning">
        <div class="kpi-value">@moderateRiskCount.ToString("N0")</div>
        <div class="kpi-label">Moderate Risk</div>
    </div>
    <div class="kpi-card success">
        <div class="kpi-value">@lowRiskCount.ToString("N0")</div>
        <div class="kpi-label">Low Risk</div>
    </div>
</div>

<div class="prediction-form">
    <h3>üéØ Classify New Shipment</h3>
    
    <div class="form-grid">
        <div class="form-group">
            <label>Route Risk: @routeRisk.ToString("P0")</label>
            <input type="range" @bind="routeRisk" min="0" max="1" step="0.1" />
        </div>
        <div class="form-group">
            <label>Supplier Reliability: @supplierReliability.ToString("P0")</label>
            <input type="range" @bind="supplierReliability" min="0" max="1" step="0.1" />
        </div>
        <div class="form-group">
            <label>Disruption Likelihood: @disruptionLikelihood.ToString("P0")</label>
            <input type="range" @bind="disruptionLikelihood" min="0" max="1" step="0.1" />
        </div>
        <div class="form-group">
            <label>Delay Probability: @delayProbability.ToString("P0")</label>
            <input type="range" @bind="delayProbability" min="0" max="1" step="0.1" />
        </div>
    </div>
    
    <button class="btn-primary" @onclick="ClassifyRisk">Classify Risk</button>
</div>

@if (showResult)
{
    <div class="result-card @GetResultClass()">
        <div class="result-icon">@GetResultIcon()</div>
        <div class="result-text">
            <h3>@riskClass</h3>
            <p>Confidence: <strong>@confidence.ToString("P1")</strong></p>
        </div>
    </div>
}

@code {
    private int totalShipments = 50000;
    private int highRiskCount = 2341;
    private int moderateRiskCount = 15234;
    private int lowRiskCount = 32425;
    
    private double routeRisk = 0.3;
    private double supplierReliability = 0.8;
    private double disruptionLikelihood = 0.2;
    private double delayProbability = 0.3;
    
    private bool showResult = false;
    private string riskClass = "";
    private double confidence = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var stats = await Http.GetFromJsonAsync<JsonElement>("http://localhost:8000/api/risk/distribution");
            totalShipments = stats.GetProperty("total").GetInt32();
            highRiskCount = stats.GetProperty("high_risk_count").GetInt32();
        }
        catch { }
    }

    private async Task ClassifyRisk()
    {
        try
        {
            var request = new
            {
                route_risk = routeRisk,
                supplier_reliability = supplierReliability,
                disruption_likelihood = disruptionLikelihood,
                delay_probability = delayProbability
            };
            
            var response = await Http.PostAsJsonAsync("http://localhost:8000/api/risk/classify", request);
            var result = await response.Content.ReadFromJsonAsync<JsonElement>();
            
            riskClass = result.GetProperty("risk_class").GetString() ?? "Unknown";
            confidence = result.GetProperty("confidence").GetDouble();
        }
        catch
        {
            var combinedScore = routeRisk * 0.25 + (1 - supplierReliability) * 0.25 + 
                               disruptionLikelihood * 0.35 + delayProbability * 0.15;
            
            if (combinedScore < 0.33) { riskClass = "Low Risk"; confidence = 1 - combinedScore; }
            else if (combinedScore < 0.66) { riskClass = "Moderate Risk"; confidence = 0.7; }
            else { riskClass = "High Risk"; confidence = combinedScore; }
        }
        
        showResult = true;
    }

    private string GetResultClass() => riskClass switch
    {
        "Low Risk" => "success",
        "Moderate Risk" => "warning",
        "High Risk" => "danger",
        _ => ""
    };

    private string GetResultIcon() => riskClass switch
    {
        "Low Risk" => "üü¢",
        "Moderate Risk" => "üü°",
        "High Risk" => "üî¥",
        _ => "‚ùì"
    };
}
